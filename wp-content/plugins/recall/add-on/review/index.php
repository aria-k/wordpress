<?phpclass rcl_review{	public function __construct() {		if (!is_admin()):			add_action('init', array(&$this, 'add_recall_user_activate'));			add_action('init', array(&$this, 'recall_user_delete_activate'));			add_filter('the_button_wprecall',array(&$this, 'get_wprecall_recall_button'),2,2);			add_filter('the_block_wprecall',array(&$this, 'user_recall_profile_block'),2,3);		else:				add_filter('admin_options_wprecall',array(&$this, 'get_admin_review_page_content'));		endif;    }		//Оставляем пользователю отзыв	function add_recall_user(){		global $user_ID,$wpdb,$rcl_options;				if(!$user_ID) wp_die('Вы не имеете на это право!');				$adressat_id = pow($_POST['user_id'], 0.5);			$content_otziv = $_POST['content_otz'];		$status = $_POST['status'];		$online = $_POST['online'];		$count_rayt = $rcl_options['count_rayt_recall'];		if($status<0) $count_rayt = $count_rayt*-1;		if($status==0)$count_rayt = 0;						$otziv = $wpdb->get_row("SELECT * FROM ".RCL_PREF."profile_otziv WHERE user_id = '$adressat_id' AND author_id = '$user_ID'");						if(!$otziv){					$content_otziv = apply_filters('rcl_content_recall',$content_otziv,$user_ID,$adressat_id);						$result = $wpdb->insert(					RCL_PREF.'profile_otziv',					array( 'author_id' => "$user_ID", 'content_otziv' => "$content_otziv", 'user_id' => "$adressat_id", 'status' => "$count_rayt" ),					array( '%d', '%s', '%d', '%d' )						);						if($rcl_options['rayt_recall_user_rayt']==1&&function_exists('update_total_rayt_user_rcl')) update_total_rayt_user_rcl($adressat_id,$count_rayt);		}						if (!$result) wp_die('Error');				do_action('rcl_add_recall',$user_ID,$adressat_id);				if($online != 0){			wp_redirect( get_redirect_url_rcl(get_author_posts_url($adressat_id),'recall'));  exit;		}				$title = 'Вам оставлен отзыв';		$to = get_the_author_meta('user_email',$adressat_id);		$mess = '		Вам был оставлен отзыв		от пользователя '.get_the_author_meta('display_name',$user_ID).'			Вы можете прочитать сообщение, перейдя по <a href="'.get_redirect_url_rcl(get_author_posts_url($user_ID),'recall').'">ссылке</a>		Это письмо было создано автоматически, не надо отвечать на него.			------------------------------		'.get_bloginfo('name');		$from='noreaply@'.$_SERVER['HTTP_HOST'];		wp_mail($to, $title, $mess, 'From:'.$from);				wp_redirect( get_redirect_url_rcl(get_author_posts_url($adressat_id),'recall') );  exit;					}	function add_recall_user_activate ( ) {	  if ( isset( $_POST['add_recall_user'] ) ) {		add_action( 'wp', array(&$this, 'add_recall_user') );	  }	}		//Удаляем отзыв	function recall_user_delete(){		global $wpdb,$user_ID,$rcl_options;		if($user_ID){			$recall_id = $_POST['recall_id'];			$user_id = $_POST['user_id'];			$rec = $wpdb->get_var("SELECT status FROM ".RCL_PREF."profile_otziv WHERE ID = '$recall_id'");						$result = $wpdb->query("DELETE FROM ".RCL_PREF."profile_otziv WHERE ID = '$recall_id'");						if($rcl_options['rayt_recall_user_rayt']==1&&function_exists('update_total_rayt_user_rcl')){				if($rec>0) $rec = $rec*(-1);				else if($rec<0) $rec = abs($rec);				update_total_rayt_user_rcl($user_id,$rec);			}						if ($result) {							wp_redirect( get_redirect_url_rcl(get_author_posts_url($user_id),'recall') );  exit;								} else {			  wp_die('Error');			}		}		}	function recall_user_delete_activate ( ) {	  if ( isset( $_POST['recall_user_delete'] ) ) {		add_action( 'wp', array(&$this, 'recall_user_delete') );	  }	}		function get_admin_review_page_content($content){		global $rcl_options;		$content .='<h2>Настройки отзывов</h2>				<div id="options-'.get_key_addon_rcl(pathinfo(__FILE__)).'" class="wrap-recall-options">			<div class="option-block">				<h3>Отзывы</h3>				<label>Название вкладки в ЛК</label>';				if(!$rcl_options['tab_review']) $rcl_options['tab_review'] = 'Отзывы';				$content .='<input type="text" name="tab_review" value="'.$rcl_options['tab_review'].'" size="10">				<small>Впишите свою надпись на кнопке переключения вкладки в личном кабинете</small>				<label>Баллы за отзыв</label>				<input type="text" name="count_rayt_recall" value="'.$rcl_options['count_rayt_recall'].'" size="10">				<small>установите сколько баллов к рейтингу будет начисляться за положительный голос или сколько баллов будет отниматься от рейтинга за отрицательный голос(по-умолчанию 1)</small>								<label>Принимать и оставлять отзыв могут</label>				<select name="type_recall" size="1">					<option value="">Все</option>					<option value="1" '.selected($rcl_options['type_recall'],1,false).'>С опубликованными записями</option>					</select>								<label>Влияние отзывов на общий рейтинг</label>				<select name="rayt_recall_user_rayt" size="1">					<option value="">Нет</option>					<option value="1" '.selected($rcl_options['rayt_recall_user_rayt'],1,false).'>Да</option>					</select>						</div>		</div>';		return $content;	}		function get_wprecall_recall_button($button,$author_lk){		global $rcl_options;		if(!$button) $status = 'active';		if(!$rcl_options['tab_review']) $rcl_options['tab_review'] = 'Отзывы';		$button .= ' <a href="#" id="recall" class="block_button '.$status.'">'.$rcl_options['tab_review'].'</a> ';		return $button;	}		function user_recall_profile_block($block_wprecall,$author_lk,$online){		global $wpdb,$user_ID,$rcl_options;		if(!$block_wprecall) $status = 'active';		$otzivy = $wpdb->get_results("SELECT * FROM ".RCL_PREF."profile_otziv WHERE user_id = '$author_lk'");			$recall_block .= '<div class="recall_block recall_content_block '.$status.'">';//начало блока с отзывами		if($otzivy){			foreach($otzivy as $otziv){				$recall_block .= '<div class="public-post recall'.$otziv->status.'">							<div class="author-avatar">'.get_avatar($otziv->author_id, 60).'</div>				<div class="content-recall">				<p>				<strong><a href="'.get_author_posts_url($otziv->author_id).'">'.get_the_author_meta('display_name', $otziv->author_id).'</a> оставил отзыв:</strong>				</p>'.$otziv->content_otziv.'</div>';				if($user_ID==$otziv->author_id){						$recall_block .= '<form method="post" action="" style="text-align: right; padding-top: 10px;">					<input type="hidden" name="user_id" value="'.$otziv->user_id.'">					<input type="hidden" name="recall_id" value="'.$otziv->ID.'">					<input type="submit" class="recall-button" name="recall_user_delete" value="Удалить">					</form>';					}				$recall_block .= '</div>';				}		}else if($user_ID==$author_lk){				$recall_block .= '<p>Вам еще не оставили ни одного отзыва</p>';			}		//получаем кол-во отзывов текущего пользователя об авторе				if($user_ID!=$author_lk&&$user_ID) {					if($rcl_options['type_recall']==1){						$count_post_author = $wpdb->get_var("SELECT COUNT(ID) FROM ".$wpdb->prefix ."posts WHERE post_author = '$user_ID' AND post_status = 'publish' LIMIT 1");				$count_post_user = $wpdb->get_var("SELECT COUNT(ID) FROM ".$wpdb->prefix ."posts WHERE post_author = '$author_lk' AND post_status = 'publish' LIMIT 1");							if(!$count_post_author||!$count_post_user){					$recall_block .= 'Пользователи без опубликованных записей не могу принимать и добавлять отзывы.';					$block_wprecall .= $recall_block;					return $block_wprecall;				}						}						$user_ID_true = $wpdb->get_var("SELECT COUNT(ID) FROM ".RCL_PREF."profile_otziv WHERE user_id = '$author_lk' AND author_id = '$user_ID' LIMIT 1");						if($user_ID_true==0):								$addres_user = pow($author_lk, 2);				$recall_block .= '<div class="otziv">					<form name="addrecall" method="post" action="">					<p>Текст отзыва:</p>					<input type="radio" name="status" value="1" id="labeled_1" /><label for="labeled_1">Положительно</label>					<input type="radio" name="status" value="0" id="labeled_2" checked="checked"/><label for="labeled_2">Нейтрально</label>					<input type="radio" name="status" value="-1" id="labeled_3" /><label for="labeled_3">Отрицательно</label><br />					<label for="content_otz"></label>					<textarea required name="content_otz" id="content_otz" rows="5" style="width:100%;padding:0;"></textarea>					<input type="hidden" name="online" value="'.$online.'">					<input type="hidden" name="user_id" value="'.$addres_user.'">					<p style="text-align:right;"><input type="submit" name="add_recall_user" class="recall-button" value="Добавить отзыв"></p>					</form>					</div>';						endif;				} 		$recall_block .= '</div>';//конец блока с отзывами				$block_wprecall .= $recall_block;		return $block_wprecall;	}}$rcl_review = new rcl_review();?>